# Validation API

**Goal:** A `validate_marketplace()` and `validate_plugin()` function that return structured warnings and errors — matching the rules `claude plugin validate` enforces.

**Ground truth from the CLI:**

```
# Marketplace warnings observed:
⚠ plugins[3].source: Plugin "npm-plugin" uses npm source which is not yet fully implemented
⚠ metadata.description: No marketplace description provided.

# Plugin: passed clean
```

---

## Design

### Return type

```python
@dataclass
class ValidationIssue:
    level: Literal["error", "warning"]
    path: str        # e.g. "plugins[3].source", "metadata.description"
    message: str

@dataclass
class ValidationResult:
    issues: list[ValidationIssue]

    @property
    def valid(self) -> bool:
        return not any(i.level == "error" for i in self.issues)

    @property
    def warnings(self) -> list[ValidationIssue]:
        return [i for i in self.issues if i.level == "warning"]

    @property
    def errors(self) -> list[ValidationIssue]:
        return [i for i in self.issues if i.level == "error"]
```

### Public API

```python
validate_marketplace(data: dict[str, Any]) -> ValidationResult
validate_plugin(data: dict[str, Any]) -> ValidationResult
```

Both accept a raw dict (already-parsed JSON). Callers can get the dict from `model.model_dump()` or from `json.loads(...)` directly.

Also expose convenience wrappers that accept a `Path`:

```python
validate_marketplace_file(path: Path) -> ValidationResult
validate_plugin_file(path: Path) -> ValidationResult
```

---

## Rules to implement

### Marketplace rules (from docs + CLI output)

**Errors:**
- `name` is missing → `"name: Required"`
- `owner` is missing → `"owner: Required"`
- `plugins` is missing → `"plugins: Required"`
- Duplicate plugin names → `'Duplicate plugin name "x" found in marketplace'`
- Source path contains `..` → `"plugins[N].source: Path traversal not allowed"`
- Reserved marketplace name used → `'Marketplace name "x" is reserved'`
  - Reserved: `claude-code-marketplace`, `claude-code-plugins`, `claude-plugins-official`, `anthropic-marketplace`, `anthropic-plugins`, `agent-skills`, `life-sciences`

**Warnings:**
- `metadata.description` is absent → `"No marketplace description provided"`
- Plugin uses `npm` source → `'Plugin "x" uses npm source which is not yet fully implemented'`
- Plugin uses `pip` source → `'Plugin "x" uses pip source which is not yet fully implemented'` (inferred — same pattern)
- `plugins` array is empty → `"Marketplace has no plugins defined"`

### Plugin rules (from docs)

**Errors:**
- `name` is missing (if manifest present) → `"name: Required"`
- Invalid JSON (caught by loader, not validator)

**Warnings:**
- None observed from the CLI on our fixture (clean pass)

---

## Package layout

```
src/claude_code_plugins_sdk/
└── validation/
    ├── __init__.py          ← validate_marketplace, validate_plugin,
    │                           validate_marketplace_file, validate_plugin_file,
    │                           ValidationResult, ValidationIssue
    ├── _marketplace.py      ← marketplace rules
    └── _plugin.py           ← plugin rules
```

Also add `_result.py` for the `ValidationResult` / `ValidationIssue` dataclasses, or put them in `__init__.py`.

---

## Update fixture

The fixture `tests/fixtures/marketplace/.claude-plugin/marketplace.json` currently has `description` at the top level but the CLI warns about `metadata.description`. The description field lives in `metadata`, not at the root. Fix the fixture to match what the CLI expects — move the description into `metadata`:

```json
{
  "metadata": {
    "description": "Example marketplace for SDK testing",
    "pluginRoot": "./plugins"
  }
}
```

And remove the top-level `"description"` field. This will make the warning go away when running `claude plugin validate` and will be the correct fixture for testing the "no description" warning path.

---

## Tests

`tests/test_validation.py`

```python
def test_marketplace_valid_no_warnings():
    # fixture with metadata.description set → no warnings
    ...

def test_marketplace_npm_source_warning():
    # marketplace with npm source → warning at plugins[N].source
    ...

def test_marketplace_pip_source_warning():
    ...

def test_marketplace_no_description_warning():
    # metadata.description absent → warning
    ...

def test_marketplace_empty_plugins_warning():
    ...

def test_marketplace_duplicate_plugin_names_error():
    ...

def test_marketplace_path_traversal_error():
    # source: "../other-plugin" → error
    ...

def test_marketplace_reserved_name_error():
    # name: "claude-code-plugins" → error
    ...

def test_plugin_valid():
    # our fixture → ValidationResult(valid=True, issues=[])
    ...

def test_validation_result_properties():
    # valid, warnings, errors properties
    ...
```

---

## Parallelization

Two independent agents:

| Agent A | Agent B |
|---|---|
| `validation/` module (result types + rules) | `tests/test_validation.py` |
| Update fixture | |
| Update `__init__.py` exports | |

Agent B can start from the plan — no need to wait for A since the API shape is fully specified here.

---

## Done when

- [ ] `validate_marketplace(data)` returns warnings matching `claude plugin validate` output
- [ ] `validate_plugin(data)` returns clean result on our fixture
- [ ] `uv run pytest` passes
- [ ] `uvx ty check` exits 0
- [ ] `uv run ruff check src/ tests/` exits 0
- [ ] `claude plugin validate tests/fixtures/marketplace` passes with 0 warnings (after fixture fix)
